name: Scrape & Update Links (JS)

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Fetch & parse HTML
        uses: actions/github-script@v7
        id: scraper
        with:
          script: |
            const fetch = require("node-fetch");
            const { JSDOM } = require("jsdom");
            const fs = require("fs");

            // 1) Fetch
            const url = "https://example.com/your-page.html";
            const res = await fetch(url);
            const text = await res.text();

            // 2) Parse
            const dom = new JSDOM(text);
            const doc = dom.window.document;
            const h2 = doc.querySelector('h2[id^="mcetoc_"]');
            if (!h2) throw new Error("No <h2> found");
            const title = h2.textContent.trim();

            // 3) Next <ul> links
            const ul = h2.nextElementSibling;
            if (!ul || ul.tagName !== "UL") throw new Error("No <ul> after <h2>");
            const links = Array.from(ul.querySelectorAll("li"))
                              .map(li => li.textContent.trim());

            // 4) Load existing JSON
            const file = "data/links.json";
            let data = {};
            if (fs.existsSync(file)) {
              data = JSON.parse(fs.readFileSync(file));
            }

            // 5) Update & write
            data[title] = links;
            fs.mkdirSync("data", { recursive: true });
            fs.writeFileSync(file, JSON.stringify(data, null, 2));

            return { title, count: links.length };

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/links.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update scraped links"
            git push
          else
            echo "No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
